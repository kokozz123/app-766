<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bộ Chỉ Số 766 - Ứng dụng Chấm Điểm</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cấu hình Import Map để load thư viện từ CDN -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.2?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react,react-dom"
        }
    }
    </script>
    
    <!-- Babel để biên dịch code React ngay tại trình duyệt -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Tùy chỉnh thanh cuộn cho đẹp hơn */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            background-color: #f8fafc; /* slate-50 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip as RechartsTooltip, Legend } from 'recharts';
        import { Upload, Save, RotateCcw, Activity, FileText, CheckCircle, Smartphone, Smile, AlertCircle, MapPin, X, Copy, Table as TableIcon, LayoutDashboard, Zap, Filter, CreditCard, History, Clock, ArrowRightLeft, Trash2, Eye } from 'lucide-react';

        // --- UI Components ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>
                {children}
            </div>
        );

        // --- Component Modal Nhập liệu nhanh ---
        const QuickInputModal = ({ isOpen, onClose, onSave, onSmartScan }) => {
            const [textInput, setTextInput] = useState('');
            const [mode, setMode] = useState('scan'); 
            const [targetCriteria, setTargetCriteria] = useState('congKhai');

            const criteriaList = [
                { key: 'congKhai', label: '1. Công khai, minh bạch (Max 18)' },
                { key: 'tienDo', label: '2. Tiến độ giải quyết (Max 20)' },
                { key: 'dvcTrucTuyen', label: '3. Dịch vụ công trực tuyến (Max 12)' },
                { key: 'thanhToanTrucTuyen', label: '4. Thanh toán trực tuyến (Max 10)' },
                { key: 'soHoa', label: '5. Số hóa hồ sơ (Max 22)' },
                { key: 'haiLong', label: '6. Mức độ hài lòng (Max 18)' },
            ];

            const template = {
                "Xã Phước Hòa": { "congKhai": 18, "tienDo": 19, "dvcTrucTuyen": 10.5, "thanhToanTrucTuyen": 8, "soHoa": 20, "haiLong": 17 },
                "Xã Phú Giáo": { "congKhai": 15, "tienDo": 16, "dvcTrucTuyen": 9, "thanhToanTrucTuyen": 7, "soHoa": 18, "haiLong": 16 },
                "Xã An Long": { "congKhai": 17, "tienDo": 18, "dvcTrucTuyen": 11, "thanhToanTrucTuyen": 9, "soHoa": 19, "haiLong": 18 },
                "Xã Phước Thành": { "congKhai": 16, "tienDo": 17, "dvcTrucTuyen": 8, "thanhToanTrucTuyen": 6, "soHoa": 15, "haiLong": 15 }
            };

            const handleFillTemplate = () => {
                setTextInput(JSON.stringify(template, null, 2));
                setMode('json');
            };

            const handleAction = () => {
                if (mode === 'json') {
                    onSave(textInput);
                } else {
                    onSmartScan(textInput, targetCriteria);
                }
                setTextInput(''); 
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden animate-in fade-in zoom-in-95 duration-200">
                        <div className="bg-blue-600 p-4 flex justify-between items-center">
                            <h3 className="text-white font-bold text-lg flex items-center gap-2">
                                <Upload className="text-white" size={20} /> Nhập Dữ Liệu
                            </h3>
                            <button onClick={onClose} className="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-1 transition-colors"><X size={20} /></button>
                        </div>
                        <div className="p-6">
                            <div className="flex bg-slate-100 p-1 rounded-lg mb-4">
                                <button onClick={() => setMode('scan')} className={`flex-1 py-2 rounded-md text-sm font-bold flex items-center justify-center gap-2 transition-all ${mode === 'scan' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Zap size={16} /> Lọc Thông Minh (Smart Scan)</button>
                                <button onClick={() => setMode('json')} className={`flex-1 py-2 rounded-md text-sm font-bold flex items-center justify-center gap-2 transition-all ${mode === 'json' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><FileText size={16} /> JSON Chuẩn</button>
                            </div>
                            {mode === 'scan' && (
                                <div className="mb-3">
                                    <label className="block text-xs font-bold text-slate-700 uppercase mb-1">Cập nhật điểm cho chỉ tiêu:</label>
                                    <select value={targetCriteria} onChange={(e) => setTargetCriteria(e.target.value)} className="w-full p-2.5 bg-white border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 outline-none">
                                        {criteriaList.map(c => (<option key={c.key} value={c.key}>{c.label}</option>))}
                                    </select>
                                </div>
                            )}
                            <div className="relative">
                                <textarea className="w-full h-48 p-4 font-mono text-xs bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none" placeholder={mode === 'scan' ? 'Dán văn bản vào đây...' : '{"Xã A": {...}}'} value={textInput} onChange={(e) => setTextInput(e.target.value)} spellCheck="false" />
                                {mode === 'json' && (<button onClick={handleFillTemplate} className="absolute top-2 right-2 text-xs bg-white border border-slate-200 shadow-sm text-slate-600 hover:text-blue-600 px-3 py-1.5 rounded-md flex items-center gap-1 font-medium transition-colors"><Copy size={12} /> Lấy mẫu</button>)}
                            </div>
                            <div className="flex gap-3 mt-6">
                                <button onClick={onClose} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">Hủy bỏ</button>
                                <button onClick={handleAction} className="flex-[2] py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-600/30 transition-all transform active:scale-95 flex items-center justify-center gap-2">{mode === 'scan' ? <Zap size={18} /> : <Save size={18} />}{mode === 'scan' ? 'QUÉT & CẬP NHẬT' : 'CẬP NHẬT JSON'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Component Quản lý Lịch sử & So sánh ---
        const HistoryManagerModal = ({ isOpen, onClose, currentData, onLoadSnapshot, calculateTotal }) => {
            const [activeTab, setActiveTab] = useState('list');
            const [snapshots, setSnapshots] = useState([]);
            const [compareA, setCompareA] = useState('');
            const [compareB, setCompareB] = useState('');
            const [saveNote, setSaveNote] = useState('');
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                try {
                    const saved = localStorage.getItem('app766_history');
                    if (saved) {
                        setSnapshots(JSON.parse(saved));
                    }
                } catch (error) {
                    console.error("Lỗi đọc dữ liệu:", error);
                    setNotification({ type: 'error', message: 'Lỗi khi đọc dữ liệu lịch sử.' });
                }
            }, []);

            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            const saveSnapshot = () => {
                try {
                    const dataToSave = JSON.parse(JSON.stringify(currentData));
                    const newSnapshot = {
                        id: Date.now(),
                        date: new Date().toLocaleString('vi-VN'),
                        note: saveNote || `Bản ghi ngày ${new Date().toLocaleDateString('vi-VN')}`,
                        data: dataToSave
                    };
                    const updated = [newSnapshot, ...snapshots];
                    setSnapshots(updated);
                    localStorage.setItem('app766_history', JSON.stringify(updated));
                    setSaveNote('');
                    setNotification({ type: 'success', message: 'Đã lưu bản ghi thành công!' });
                } catch (error) {
                    console.error(error);
                    setNotification({ type: 'error', message: 'Không thể lưu. Có thể bộ nhớ đầy.' });
                }
            };

            const deleteSnapshot = (id) => {
                if (window.confirm('Bạn có chắc muốn xóa bản ghi này? Hành động này không thể hoàn tác.')) {
                    try {
                        const updated = snapshots.filter(s => s.id !== id);
                        setSnapshots(updated);
                        localStorage.setItem('app766_history', JSON.stringify(updated));
                        if (compareA == id) setCompareA('');
                        if (compareB == id) setCompareB('');
                        setNotification({ type: 'success', message: 'Đã xóa bản ghi.' });
                    } catch (error) {
                        setNotification({ type: 'error', message: 'Lỗi khi xóa dữ liệu.' });
                    }
                }
            };

            const getCompareData = (id) => {
                if (!id) return null;
                if (id === 'current') return { note: 'Dữ liệu hiện tại', data: currentData };
                return snapshots.find(s => s.id.toString() === id.toString());
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] overflow-hidden flex flex-col animate-in fade-in zoom-in-95 duration-200">
                        <div className="bg-slate-800 p-4 flex justify-between items-center text-white shrink-0">
                            <h3 className="font-bold text-lg flex items-center gap-2">
                                <History size={20} /> Lịch Sử & So Sánh
                            </h3>
                            <button onClick={onClose} className="hover:bg-white/20 p-1 rounded-full transition-colors"><X size={20} /></button>
                        </div>

                        {notification && (
                            <div className={`p-2 text-center text-sm font-bold text-white shrink-0 ${notification.type === 'success' ? 'bg-green-500' : 'bg-red-500'} animate-in slide-in-from-top duration-300`}>
                                {notification.message}
                            </div>
                        )}

                        <div className="flex border-b border-slate-200 bg-slate-50 shrink-0">
                            <button onClick={() => setActiveTab('list')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${activeTab === 'list' ? 'bg-white text-blue-600 border-t-2 border-blue-600' : 'text-slate-500 hover:bg-slate-100'}`}>
                                <Clock size={16} /> Danh sách bản ghi
                            </button>
                            <button onClick={() => setActiveTab('compare')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${activeTab === 'compare' ? 'bg-white text-indigo-600 border-t-2 border-indigo-600' : 'text-slate-500 hover:bg-slate-100'}`}>
                                <ArrowRightLeft size={16} /> So sánh chi tiết
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-6 bg-slate-50">
                            {activeTab === 'list' ? (
                                <div className="space-y-6">
                                    <div className="bg-white p-4 rounded-xl border border-blue-100 shadow-sm flex flex-col md:flex-row gap-4 items-end">
                                        <div className="flex-1 w-full">
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Tạo bản ghi mới từ dữ liệu hiện tại</label>
                                            <input type="text" placeholder="VD: Dữ liệu tháng 10/2025..." className="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={saveNote} onChange={(e) => setSaveNote(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && saveSnapshot()} />
                                        </div>
                                        <button onClick={saveSnapshot} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2 text-sm shrink-0">
                                            <Save size={16} /> Lưu lại ngay
                                        </button>
                                    </div>

                                    <div className="space-y-3">
                                        <h4 className="font-bold text-slate-700">Các bản ghi đã lưu ({snapshots.length})</h4>
                                        {snapshots.length === 0 && <p className="text-slate-400 text-sm italic">Chưa có bản ghi nào.</p>}
                                        {snapshots.map(snap => (
                                            <div key={snap.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow">
                                                <div>
                                                    <div className="font-bold text-slate-800">{snap.note}</div>
                                                    <div className="text-xs text-slate-500 flex items-center gap-1 mt-1"><Clock size={12}/> {snap.date}</div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => { onLoadSnapshot(snap.data); setNotification({type:'success', message: 'Đã tải dữ liệu thành công!'}); }} className="px-3 py-1.5 bg-green-50 text-green-700 border border-green-200 rounded-lg text-xs font-bold hover:bg-green-100 flex items-center gap-1">
                                                        <Eye size={14} /> Xem/Khôi phục
                                                    </button>
                                                    <button onClick={() => deleteSnapshot(snap.id)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                                        <Trash2 size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kỳ dữ liệu A (Gốc)</label>
                                            <select className="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white" onChange={(e) => setCompareA(e.target.value)} value={compareA}>
                                                <option value="">-- Chọn --</option>
                                                <option value="current">Dữ liệu hiện tại (Đang nhập)</option>
                                                {snapshots.map(s => <option key={s.id} value={s.id}>{s.note} ({s.date})</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kỳ dữ liệu B (So sánh)</label>
                                            <select className="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white" onChange={(e) => setCompareB(e.target.value)} value={compareB}>
                                                <option value="">-- Chọn --</option>
                                                <option value="current">Dữ liệu hiện tại (Đang nhập)</option>
                                                {snapshots.map(s => <option key={s.id} value={s.id}>{s.note} ({s.date})</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    {compareA && compareB && (
                                        <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                                            {(() => {
                                                const dataA = getCompareData(compareA);
                                                const dataB = getCompareData(compareB);
                                                if (!dataA || !dataB) return null;

                                                return (
                                                    <table className="w-full text-sm text-left">
                                                        <thead className="bg-slate-100 text-slate-500 uppercase text-xs">
                                                            <tr>
                                                                <th className="px-4 py-3">Đơn vị</th>
                                                                <th className="px-4 py-3 text-right">{dataA.note}</th>
                                                                <th className="px-4 py-3 text-right">{dataB.note}</th>
                                                                <th className="px-4 py-3 text-right">Chênh lệch</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-slate-100">
                                                            {Object.keys(dataA.data).map(unit => {
                                                                const scoreA = parseFloat(calculateTotal(dataA.data[unit] || {}));
                                                                const scoreB = parseFloat(calculateTotal(dataB.data[unit] || {}));
                                                                const diff = scoreB - scoreA;
                                                                const diffColor = diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-600' : 'text-slate-400';
                                                                const diffSign = diff > 0 ? '+' : '';

                                                                return (
                                                                    <tr key={unit} className="hover:bg-slate-50">
                                                                        <td className="px-4 py-3 font-bold text-slate-700">{unit}</td>
                                                                        <td className="px-4 py-3 text-right font-mono text-slate-600">{scoreA.toFixed(2)}</td>
                                                                        <td className="px-4 py-3 text-right font-mono text-blue-600 font-bold">{scoreB.toFixed(2)}</td>
                                                                        <td className={`px-4 py-3 text-right font-mono font-bold ${diffColor}`}>
                                                                            {diffSign}{diff.toFixed(2)}
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                );
                                            })()}
                                        </div>
                                    )}
                                    {(!compareA || !compareB) && (
                                        <div className="text-center py-10 text-slate-400 italic">Vui lòng chọn 2 kỳ dữ liệu để bắt đầu so sánh</div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Component Bảng So Sánh ---
        const ComparisonTable = ({ data, calculateTotal, getGrade }) => {
            const criteria = [
                { key: 'congKhai', label: '1. Công khai, minh bạch', max: 18 },
                { key: 'tienDo', label: '2. Tiến độ giải quyết', max: 20 },
                { key: 'dvcTrucTuyen', label: '3. Dịch vụ công trực tuyến', max: 12 },
                { key: 'thanhToanTrucTuyen', label: '4. Thanh toán trực tuyến', max: 10 },
                { key: 'soHoa', label: '5. Số hóa hồ sơ', max: 22 },
                { key: 'haiLong', label: '6. Mức độ hài lòng', max: 18 },
            ];

            return (
                <Card className="overflow-hidden">
                    <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2">
                            <TableIcon className="text-blue-600" size={20}/> Bảng So Sánh Chi Tiết (Hiện tại)
                        </h3>
                        <span className="text-xs text-slate-500 italic">Đơn vị tính: Điểm</span>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="text-xs text-slate-500 uppercase bg-slate-100 border-b border-slate-200">
                                <tr>
                                    <th className="px-6 py-4 font-bold">Tiêu chí đánh giá</th>
                                    <th className="px-6 py-4 text-center font-bold text-slate-400 w-24">Điểm chuẩn</th>
                                    {Object.keys(data).map(name => (
                                        <th key={name} className="px-6 py-4 text-center font-bold text-slate-800 min-w-[120px]">{name}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {criteria.map((item) => (
                                    <tr key={item.key} className="hover:bg-slate-50 transition-colors">
                                        <td className="px-6 py-3 font-medium text-slate-700">{item.label}</td>
                                        <td className="px-6 py-3 text-center text-slate-400 bg-slate-50/50">{item.max}</td>
                                        {Object.keys(data).map(name => (
                                            <td key={`${name}-${item.key}`} className="px-6 py-3 text-center font-semibold text-slate-600">
                                                {Number(data[name][item.key])}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                                <tr className="bg-blue-50/50 border-t-2 border-slate-200">
                                    <td className="px-6 py-4 font-bold text-blue-900 text-base">TỔNG CỘNG</td>
                                    <td className="px-6 py-4 text-center font-bold text-slate-400">100</td>
                                    {Object.keys(data).map(name => {
                                        const total = calculateTotal(data[name]);
                                        return (
                                            <td key={`${name}-total`} className="px-6 py-4 text-center">
                                                <div className="font-bold text-lg text-blue-700">{total}</div>
                                            </td>
                                        );
                                    })}
                                </tr>
                                <tr>
                                    <td className="px-6 py-4 font-bold text-slate-700">XẾP LOẠI</td>
                                    <td className="px-6 py-4 text-center text-slate-400">-</td>
                                    {Object.keys(data).map(name => {
                                        const total = calculateTotal(data[name]);
                                        const grade = getGrade(total);
                                        return (
                                            <td key={`${name}-grade`} className="px-6 py-4 text-center">
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold border ${grade.color} ${grade.bg} ${grade.border}`}>
                                                    {grade.label}
                                                </span>
                                            </td>
                                        );
                                    })}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </Card>
            );
        };

        const InputGroup = ({ label, max, value, onChange, icon }) => (
            <div>
                <div className="flex justify-between mb-2">
                    <label className="text-sm font-semibold text-slate-700 flex items-center gap-2">{icon} {label}</label>
                    <span className="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">Max: {max}</span>
                </div>
                <div className="flex items-center gap-3">
                    <input type="range" min="0" max={max} step="0.1" value={value} onChange={(e) => onChange(e.target.value)} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600 hover:bg-slate-300 transition-colors"/>
                    <input type="number" min="0" max={max} value={value} onChange={(e) => { const val = parseFloat(e.target.value); if (val <= max && val >= 0) onChange(val); }} className="w-14 p-1.5 text-center border border-slate-200 bg-slate-50 rounded-lg text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none"/>
                </div>
            </div>
        );

        // --- Main App ---
        const App = () => {
            const defaultUnitScore = {
                congKhai: 15.5, tienDo: 18.2, dvcTrucTuyen: 10.5, thanhToanTrucTuyen: 8.0, soHoa: 18.0, haiLong: 17.5
            };

            const [allData, setAllData] = useState({
                "Xã Phước Hòa": { ...defaultUnitScore },
                "Xã Phú Giáo": { ...defaultUnitScore, congKhai: 12, tienDo: 15 },
                "Xã An Long": { ...defaultUnitScore, soHoa: 20 },
                "Xã Phước Thành": { ...defaultUnitScore, haiLong: 16 }
            });

            const [selectedCommune, setSelectedCommune] = useState("Xã Phước Hòa");
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false); 
            const [viewMode, setViewMode] = useState('dashboard');

            const currentScores = allData[selectedCommune];
            const calculateTotal = (scores) => Object.values(scores).reduce((acc, curr) => acc + Number(curr), 0).toFixed(2);
            const totalScore = calculateTotal(currentScores);

            const getGrade = (score) => {
                if (score >= 90) return { label: 'XUẤT SẮC', color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200' };
                if (score >= 80) return { label: 'TỐT', color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-200' };
                if (score >= 70) return { label: 'KHÁ', color: 'text-yellow-600', bg: 'bg-yellow-50', border: 'border-yellow-200' };
                if (score >= 50) return { label: 'TRUNG BÌNH', color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200' };
                return { label: 'YẾU', color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200' };
            };

            const currentGrade = getGrade(totalScore);

            const handleInputChange = (key, value) => {
                setAllData(prev => ({
                    ...prev,
                    [selectedCommune]: { ...prev[selectedCommune], [key]: value }
                }));
            };

            const handleBatchUpdateJson = (jsonString) => {
                try {
                    const parsed = JSON.parse(jsonString);
                    const firstKey = Object.keys(parsed)[0];
                    const isMultiCommune = typeof parsed[firstKey] === 'object';
                    if (isMultiCommune) {
                        setAllData(prev => ({ ...prev, ...parsed }));
                        setSelectedCommune(Object.keys(parsed)[0]);
                        alert(`Đã nhập thành công dữ liệu cho: ${Object.keys(parsed).join(', ')}`);
                        setIsModalOpen(false);
                    } else {
                        setAllData(prev => ({ ...prev, [selectedCommune]: { ...prev[selectedCommune], ...parsed } }));
                        alert(`Đã cập nhật dữ liệu cho ${selectedCommune}!`);
                        setIsModalOpen(false);
                    }
                } catch (e) {
                    alert('Lỗi: Dữ liệu JSON không đúng định dạng.');
                }
            };

            const handleSmartScan = (text, criteriaKey) => {
                const keywords = [
                    { id: "Xã Phước Hòa", patterns: ["Xã Phước Hòa", "Phước Hòa"] },
                    { id: "Xã Phú Giáo", patterns: ["Xã Phú Giáo", "Phú Giáo"] },
                    { id: "Xã An Long", patterns: ["Xã An Long", "An Long"] },
                    { id: "Xã Phước Thành", patterns: ["Xã Phước Thành", "Phước Thành"] }
                ];
                let updatedCount = 0;
                let newUserData = { ...allData };
                keywords.forEach(unit => {
                    const patternStr = `(${unit.patterns.join('|')})[^0-9]*([0-9]+(\\.[0-9]+)?)`;
                    const regex = new RegExp(patternStr, "i");
                    const match = text.match(regex);
                    if (match && match[2]) {
                        const score = parseFloat(match[2]);
                        if (!isNaN(score)) {
                            newUserData[unit.id] = { ...newUserData[unit.id], [criteriaKey]: score };
                            updatedCount++;
                        }
                    }
                });
                if (updatedCount > 0) {
                    setAllData(newUserData);
                    alert(`Đã tìm thấy và cập nhật điểm "${criteriaKey}" cho ${updatedCount} xã thành công!`);
                    setIsModalOpen(false);
                } else {
                    alert("Không tìm thấy thông tin điểm số nào phù hợp trong văn bản cho 4 xã này.");
                }
            };

            const chartData = [
                { name: 'Công khai', value: Number(currentScores.congKhai), max: 18, fill: '#3b82f6' },
                { name: 'Tiến độ', value: Number(currentScores.tienDo), max: 20, fill: '#10b981' },
                { name: 'DVC TT', value: Number(currentScores.dvcTrucTuyen), max: 12, fill: '#8b5cf6' },
                { name: 'Thanh toán', value: Number(currentScores.thanhToanTrucTuyen), max: 10, fill: '#6366f1' },
                { name: 'Số hóa', value: Number(currentScores.soHoa), max: 22, fill: '#f59e0b' },
                { name: 'Hài lòng', value: Number(currentScores.haiLong), max: 18, fill: '#ec4899' },
            ];
            const gaugeData = [{ name: 'Đạt', value: Number(totalScore) }, { name: 'Thiếu', value: 100 - Number(totalScore) }];

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        <QuickInputModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleBatchUpdateJson} onSmartScan={handleSmartScan} />
                        
                        <HistoryManagerModal 
                            isOpen={isHistoryOpen} 
                            onClose={() => setIsHistoryOpen(false)} 
                            currentData={allData} 
                            onLoadSnapshot={(data) => { setAllData(data); alert('Đã khôi phục dữ liệu thành công!'); }}
                            calculateTotal={calculateTotal}
                        />

                        <header className="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold text-slate-900 flex items-center gap-2">
                                    <Activity className="text-blue-600" />
                                    Bộ Chỉ Số 766
                                </h1>
                                <p className="text-slate-500 mt-1 text-sm">Phước Hòa - Phú Giáo - An Long - Phước Thành</p>
                            </div>
                            
                            <div className="flex flex-wrap items-center gap-3 w-full md:w-auto">
                                <button 
                                    onClick={() => setIsHistoryOpen(true)}
                                    className="px-4 py-2 bg-white text-slate-700 border border-slate-300 rounded-lg font-bold hover:bg-slate-50 transition-all flex items-center gap-2 text-sm shadow-sm"
                                >
                                    <History size={16} /> Lịch sử & So sánh
                                </button>

                                <button 
                                    onClick={() => setIsModalOpen(true)}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-all flex items-center gap-2 text-sm"
                                >
                                    <Upload size={16} /> NHẬP DỮ LIỆU
                                </button>
                                
                                <div className="flex bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                                    <button onClick={() => setViewMode('dashboard')} className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-1 transition-all ${viewMode === 'dashboard' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}>
                                        <LayoutDashboard size={14} /> Dashboard
                                    </button>
                                    <button onClick={() => setViewMode('comparison')} className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-1 transition-all ${viewMode === 'comparison' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}>
                                        <TableIcon size={14} /> Bảng So Sánh
                                    </button>
                                </div>
                            </div>
                        </header>

                        {viewMode === 'dashboard' ? (
                            <>
                                <div className="flex overflow-x-auto pb-4 gap-3 mb-2 no-scrollbar">
                                    {Object.keys(allData).map((name) => {
                                        const score = calculateTotal(allData[name]);
                                        const isActive = selectedCommune === name;
                                        return (
                                            <button key={name} onClick={() => setSelectedCommune(name)} className={`flex-shrink-0 px-5 py-3 rounded-xl text-sm font-semibold transition-all duration-200 border flex flex-col items-start gap-1 min-w-[140px] ${isActive ? 'bg-white border-blue-500 shadow-md ring-1 ring-blue-500' : 'bg-white border-slate-200 hover:bg-slate-50 hover:border-slate-300'}`}>
                                                <div className="flex items-center gap-2 w-full justify-between">
                                                    <span className={`flex items-center gap-1 ${isActive ? 'text-blue-700' : 'text-slate-600'}`}><MapPin size={14} /> {name}</span>
                                                    {isActive && <div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>}
                                                </div>
                                                <div className="text-2xl font-bold text-slate-800">{score} <span className="text-[10px] text-slate-400 font-normal">điểm</span></div>
                                            </button>
                                        );
                                    })}
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-300">
                                    <div className="lg:col-span-1 space-y-6">
                                        <Card className="p-5 border-t-4 border-t-blue-500">
                                            <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                                                <h3 className="font-bold text-lg text-slate-800">Chi tiết: {selectedCommune}</h3>
                                            </div>
                                            <div className="space-y-6">
                                                <InputGroup label="1. Công khai, minh bạch" max={18} value={currentScores.congKhai} onChange={(v) => handleInputChange('congKhai', v)} icon={<FileText size={18} className="text-blue-500" />}/>
                                                <InputGroup label="2. Tiến độ giải quyết" max={20} value={currentScores.tienDo} onChange={(v) => handleInputChange('tienDo', v)} icon={<CheckCircle size={18} className="text-emerald-500" />}/>
                                                <div className="p-3 bg-blue-50/50 rounded-lg border border-blue-100 space-y-4">
                                                    <div className="text-xs font-bold text-blue-800 uppercase mb-2">Nhóm Dịch vụ trực tuyến</div>
                                                    <InputGroup label="3. DVC Trực tuyến" max={12} value={currentScores.dvcTrucTuyen} onChange={(v) => handleInputChange('dvcTrucTuyen', v)} icon={<Smartphone size={18} className="text-purple-500" />}/>
                                                    <InputGroup label="4. Thanh toán TT" max={10} value={currentScores.thanhToanTrucTuyen} onChange={(v) => handleInputChange('thanhToanTrucTuyen', v)} icon={<CreditCard size={18} className="text-indigo-500" />}/>
                                                </div>
                                                <InputGroup label="5. Số hóa hồ sơ" max={22} value={currentScores.soHoa} onChange={(v) => handleInputChange('soHoa', v)} icon={<Save size={18} className="text-amber-500" />}/>
                                                <InputGroup label="6. Mức độ hài lòng" max={18} value={currentScores.haiLong} onChange={(v) => handleInputChange('haiLong', v)} icon={<Smile size={18} className="text-pink-500" />}/>
                                            </div>
                                        </Card>
                                    </div>

                                    <div className="lg:col-span-2 space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <Card className="p-6 flex flex-row items-center justify-between relative overflow-hidden bg-slate-900 text-white">
                                                <div className="z-10">
                                                    <h3 className="text-slate-400 font-medium mb-1 uppercase text-xs tracking-wider">Tổng điểm</h3>
                                                    <div className="text-6xl font-bold tracking-tight">{totalScore}</div>
                                                    <div className={`inline-flex mt-3 px-3 py-1 rounded-md text-sm font-bold bg-white/10 border border-white/20 ${currentGrade.color.replace('text-', 'text-white ')}`}>{currentGrade.label}</div>
                                                </div>
                                                <div className="h-32 w-32 relative z-10">
                                                    <ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={gaugeData} cx="50%" cy="50%" innerRadius={40} outerRadius={55} startAngle={90} endAngle={-270} dataKey="value" paddingAngle={5}><Cell fill="#3b82f6" stroke="none" /><Cell fill="#334155" stroke="none" /></Pie></PieChart></ResponsiveContainer>
                                                    <div className="absolute inset-0 flex items-center justify-center font-bold text-sm text-blue-400">{Math.round(totalScore)}%</div>
                                                </div>
                                                <div className="absolute right-0 top-0 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                                            </Card>
                                            <Card className="p-6">
                                                <h3 className="text-slate-800 font-bold text-sm uppercase mb-4 flex items-center gap-2"><BarChart className="text-slate-400" size={16}/> Biểu đồ thành phần</h3>
                                                <div className="h-48 w-full">
                                                    <ResponsiveContainer width="100%" height="100%">
                                                        <BarChart data={chartData} margin={{ top: 10, right: 10, left: -20, bottom: 0 }} barSize={30}>
                                                            <XAxis dataKey="name" tick={{fontSize: 10, fill: '#64748b'}} axisLine={false} tickLine={false} dy={10} interval={0} />
                                                            <YAxis domain={[0, 'auto']} hide />
                                                            <RechartsTooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)' }} cursor={{fill: '#f1f5f9', radius: 4}}/>
                                                            <Bar dataKey="value" radius={[4, 4, 4, 4]}>{chartData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.fill} />)}</Bar>
                                                        </BarChart>
                                                    </ResponsiveContainer>
                                                </div>
                                            </Card>
                                        </div>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-300">
                                <ComparisonTable data={allData} calculateTotal={calculateTotal} getGrade={getGrade} />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>